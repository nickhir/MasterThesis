---
title: "Supplementary Figure 2 Doublet Detection"
author: "Nick Hirschm√ºller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
---


```{r setup, echo=F, message=F, error=F}
knitr::opts_chunk$set(echo = T, message = F, warning = F)
```


```{r}
# load libraries
library(tidyverse)
library(Seurat)
library(patchwork)

# load the plot theme
source("/g/huber/users/hirschmueller/DECODE/MasterThesis/scripts/plot_theme.R")
```

```{r}
# load data
ctrl_integrated <- qs::qread("/g/huber/users/hirschmueller/DECODE/analysis/ctrl_3prime/results/integration/seurat_integration.qs")
ctrl_integrated$celltype_manual <- ifelse(ctrl_integrated$celltype_manual == "HSP-EB", "EB", ctrl_integrated$celltype_manual)
ctrl_integrated$celltype_manual <- ifelse(ctrl_integrated$celltype_manual == "R3", "mEC", ctrl_integrated$celltype_manual)

ctrl_integrated_singlet <- qs::qread("/g/huber/users/hirschmueller/DECODE/analysis/ctrl_3prime/results/DoubletDetection/seurat_integrated_only_singlets.qs")
ctrl_integrated_singlet$celltype_manual <- ifelse(ctrl_integrated_singlet$celltype_manual == "HSP-EB", "EB", ctrl_integrated_singlet$celltype_manual)
ctrl_integrated_singlet$celltype_manual <- ifelse(ctrl_integrated_singlet$celltype_manual == "R3", "mEC", ctrl_integrated_singlet$celltype_manual)
```

```{r}
# define a color palette for our data
color_palette <- c("#009E73", "#56B4E9", "#E69F00", "#C7B900", "#D55E00", "#CC79A7", "#8EBD59", "#A377C8","#999999", "#EB6864", "#709DAD")

# we have to turn the celltype into a factor with the same ordering for both ctrl and notch.
ctrl_integrated$celltype_manual <- factor(ctrl_integrated$celltype_manual, 
                                          levels = c("ISC", "EB", "daEC" ,"aEC", "Copper","pEC", "EE", "unk","MT", "dEC","mEC"))


#######################
# CELLTYPE ANNOTATION #
####################### 
p_celltype <- DimPlot(ctrl_integrated,
                      pt.size = 0.007,
                      group.by = "celltype_manual",
                      label = T,
                      label.box = T,repel = T,
                      label.size = 4)+
  theme_UMAP()+
  NoLegend()+
  ggtitle("Celltype Annotation")+
  xlab("UMAP 1")+
  ylab("UMAP 2")+
  theme(plot.title = element_text(size=11,face="bold",hjust = 0.5),
        legend.position = "none")+
  scale_color_manual(values=color_palette)+
  scale_fill_manual(values=color_palette)+
  scale_y_reverse()



#################
# DoubletFinder #
#################
ctrl_integrated <- qs::qread("/g/huber/users/hirschmueller/DECODE/analysis/ctrl_3prime/results/DoubletDetection/seurat_integrated_doublet_label.qs")
doublet_labels <- rownames(ctrl_integrated[, ctrl_integrated$doublet_label=="Doublet"]@meta.data)
p_doubletFinder<-DimPlot(ctrl_integrated,
                         pt.size = 0.007,
                         cells.highlight= list("Doublet"=doublet_labels), 
                         cols.highlight = "darkred", cols= "grey",
                         sizes.highlight = 0.15)+
  theme_UMAP()+
  NoLegend()+
  ggtitle("DoubletFinder")+
  xlab("UMAP 1")+
  ylab("UMAP 2")+
  theme(plot.title = element_text(size=11,face="bold",hjust = 0.5))+
  scale_y_reverse()

############
# Scrublet #
############
doublet_labels <- rownames(ctrl_integrated[,ctrl_integrated$scrublet_prediction=="Doublet"]@meta.data)
p_scrublet<-DimPlot(ctrl_integrated, 
                    pt.size = 0.007,
                    cells.highlight= list("Doublet"=doublet_labels), 
                    cols.highlight = "darkred", cols= "grey",
                    sizes.highlight = 0.15)+
  theme_UMAP()+
  NoLegend()+
  ggtitle("Scrublet")+
  xlab("UMAP 1")+
  ylab("UMAP 2")+
  theme(plot.title = element_text(size=11,face="bold",hjust = 0.5))+
  scale_y_reverse()

####################
# DOUBLETS REMOVED #
####################
ctrl_integrated_singlet$celltype_manual <- factor(ctrl_integrated_singlet$celltype_manual, 
                                          levels = c("ISC", "EB", "daEC" ,"aEC", "Copper","pEC", "EE", "unk","MT", "dEC","mEC"))
p_singlets<-DimPlot(ctrl_integrated_singlet,
                    reduction = "umap", 
                    group.by = "celltype_manual", 
                    label = T,
                    label.box = T,
                    repel = T,
                    pt.size = 0.007,
                    label.size = 4) +
  theme_UMAP()+
  NoLegend()+
  xlab("UMAP 1")+
  ylab("UMAP 2")+
  ggtitle("Celltype Annotation\nw/o Doublets")+
  theme(plot.title = element_text(size=11,face="bold",hjust = 0.5))+
  scale_color_manual(values=color_palette) +
  scale_fill_manual(values=color_palette)
```


```{r, fig.width=7, fig.height=2.58, fig.align="center", dpi=300}
combined <- wrap_plots(p_celltype, p_doubletFinder, p_scrublet, p_singlets, nrow = 1) +
  plot_annotation(tag_levels = "A") & 
  theme(plot.tag = element_text(size = 18, face="bold"))

ragg::agg_png("/g/huber/users/hirschmueller/DECODE/MasterThesis/plots/Sup_fig2_doublet_identification.png", 
              width = 10, height = 3.2, res=350, units = "in", scaling = 0.88)
combined
dev.off()


```

![](/g/huber/users/hirschmueller/DECODE/MasterThesis/plots/Sup_fig2_doublet_identification.png)

```{r}
sessionInfo()
```
